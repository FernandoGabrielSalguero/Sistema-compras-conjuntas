<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset ULTRA AGRESIVO - SVE</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 700px;
            width: 100%;
            padding: 40px;
        }
        h1 {
            color: #d32f2f;
            font-size: 32px;
            margin-bottom: 10px;
            text-align: center;
        }
        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }
        .warning strong {
            display: block;
            margin-bottom: 5px;
            font-size: 18px;
        }
        button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover {
            background: #b71c1c;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(211, 47, 47, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button.secondary {
            background: #757575;
        }
        button.secondary:hover {
            background: #616161;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }
        #log:empty {
            display: none;
        }
        .log-line {
            margin-bottom: 5px;
            padding: 3px 0;
        }
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .warning-log { color: #ff9800; font-weight: bold; }
        .info { color: #2196f3; }
        .debug { color: #9e9e9e; }
        .separator {
            color: #666;
            margin: 10px 0;
            font-weight: bold;
        }
        .progress {
            margin: 20px 0;
            display: none;
        }
        .progress.active {
            display: block;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• RESET ULTRA AGRESIVO üî•</h1>

        <div class="warning">
            <strong>‚ö†Ô∏è ADVERTENCIA EXTREMA</strong>
            Este reset eliminar√° ABSOLUTAMENTE TODO sin piedad:
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li>TODOS los Service Workers (todas las versiones)</li>
                <li>TODAS las Caches (sin excepciones)</li>
                <li>TODAS las bases de datos IndexedDB</li>
                <li>TODO el LocalStorage</li>
                <li>TODO el SessionStorage</li>
                <li>Verificaci√≥n m√∫ltiple para garantizar eliminaci√≥n completa</li>
            </ul>
        </div>

        <button id="btnReset" onclick="ultraAggressiveReset()">
            üí£ EJECUTAR RESET NUCLEAR üí£
        </button>

        <button class="secondary" onclick="goToLogin()">
            ‚Üê Cancelar y volver al Login
        </button>

        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <div id="log"></div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let progressElement = document.getElementById('progress');
        let progressFill = document.getElementById('progressFill');
        let currentProgress = 0;

        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            const timestamp = new Date().toLocaleTimeString('es-AR', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                fractionalSecondDigits: 3
            });
            line.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(line);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[RESET] ${message}`);
        }

        function updateProgress(percent, label) {
            currentProgress = percent;
            progressFill.style.width = percent + '%';
            progressFill.textContent = label || (percent + '%');
        }

        function separator() {
            log('‚ïê'.repeat(60), 'separator');
        }

        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function ultraAggressiveReset() {
            const btn = document.getElementById('btnReset');
            btn.disabled = true;
            btn.textContent = '‚è≥ DESTRUYENDO TODO...';

            progressElement.classList.add('active');
            logElement.innerHTML = '';

            separator();
            log('üî•üî•üî• INICIANDO RESET NUCLEAR üî•üî•üî•', 'error');
            separator();

            try {
                // ============================================
                // FASE 1: DESTRUCCI√ìN DE SERVICE WORKERS
                // ============================================
                updateProgress(10, 'Fase 1/6');
                log('FASE 1: Aniquilando Service Workers...', 'warning-log');

                if ('serviceWorker' in navigator) {
                    // Primer barrido
                    let regs = await navigator.serviceWorker.getRegistrations();
                    log(`Encontrados ${regs.length} Service Worker(s)`, 'info');

                    for (const reg of regs) {
                        try {
                            const url = reg.active?.scriptURL || reg.waiting?.scriptURL || reg.installing?.scriptURL || 'unknown';
                            await reg.unregister();
                            log(`‚úì SW desregistrado: ${url}`, 'success');
                        } catch (e) {
                            log(`‚úó Error desregistrando SW: ${e.message}`, 'error');
                        }
                    }

                    await sleep(500);

                    // Segundo barrido (paranoico)
                    regs = await navigator.serviceWorker.getRegistrations();
                    if (regs.length > 0) {
                        log(`‚ö† A√∫n quedan ${regs.length} SW, segundo barrido...`, 'warning-log');
                        for (const reg of regs) {
                            await reg.unregister();
                        }
                    }

                    await sleep(500);

                    // Verificaci√≥n final
                    regs = await navigator.serviceWorker.getRegistrations();
                    if (regs.length === 0) {
                        log('‚úì‚úì‚úì TODOS los Service Workers eliminados', 'success');
                    } else {
                        log(`‚ö† A√∫n quedan ${regs.length} SW residuales`, 'warning-log');
                    }
                } else {
                    log('Service Worker API no disponible', 'debug');
                }

                // ============================================
                // FASE 2: DESTRUCCI√ìN DE CACHES
                // ============================================
                updateProgress(25, 'Fase 2/6');
                await sleep(300);
                separator();
                log('FASE 2: Pulverizando Caches...', 'warning-log');

                if (window.caches) {
                    let cacheKeys = await caches.keys();
                    log(`Encontradas ${cacheKeys.length} cache(s)`, 'info');

                    for (const key of cacheKeys) {
                        try {
                            await caches.delete(key);
                            log(`‚úì Cache destruida: ${key}`, 'success');
                        } catch (e) {
                            log(`‚úó Error eliminando cache ${key}: ${e.message}`, 'error');
                        }
                    }

                    await sleep(500);

                    // Verificaci√≥n paranoica
                    cacheKeys = await caches.keys();
                    if (cacheKeys.length === 0) {
                        log('‚úì‚úì‚úì TODAS las caches eliminadas', 'success');
                    } else {
                        log(`‚ö† A√∫n quedan ${cacheKeys.length} cache(s): ${cacheKeys.join(', ')}`, 'warning-log');
                        // Tercer intento
                        for (const key of cacheKeys) {
                            await caches.delete(key);
                        }
                    }
                } else {
                    log('Cache API no disponible', 'debug');
                }

                // ============================================
                // FASE 3: DESTRUCCI√ìN DE INDEXEDDB
                // ============================================
                updateProgress(45, 'Fase 3/6');
                await sleep(300);
                separator();
                log('FASE 3: Arrasando IndexedDB...', 'warning-log');

                if (window.indexedDB) {
                    try {
                        // Intentar obtener lista de bases de datos
                        if (indexedDB.databases) {
                            const databases = await indexedDB.databases();
                            log(`Encontradas ${databases.length} base(s) de datos`, 'info');

                            for (const db of databases) {
                                if (db.name) {
                                    try {
                                        await new Promise((resolve, reject) => {
                                            const req = indexedDB.deleteDatabase(db.name);
                                            req.onsuccess = () => {
                                                log(`‚úì DB eliminada: ${db.name}`, 'success');
                                                resolve();
                                            };
                                            req.onerror = () => reject(req.error);
                                            req.onblocked = () => {
                                                log(`‚ö† DB bloqueada: ${db.name}, forzando...`, 'warning-log');
                                                setTimeout(resolve, 1000);
                                            };
                                        });
                                    } catch (e) {
                                        log(`‚úó Error eliminando DB ${db.name}: ${e.message}`, 'error');
                                    }
                                }
                            }
                        }

                        // Eliminar bases de datos conocidas por nombre (por si acaso)
                        const knownDatabases = ['SVE_DroneSync', 'sve_offline', 'offline_sync'];
                        for (const dbName of knownDatabases) {
                            try {
                                await new Promise((resolve, reject) => {
                                    const req = indexedDB.deleteDatabase(dbName);
                                    req.onsuccess = () => {
                                        log(`‚úì DB conocida eliminada: ${dbName}`, 'success');
                                        resolve();
                                    };
                                    req.onerror = () => resolve(); // Ignorar si no existe
                                    req.onblocked = () => setTimeout(resolve, 500);
                                });
                            } catch (e) {
                                // Ignorar errores de bases que no existen
                            }
                        }

                        log('‚úì‚úì‚úì IndexedDB completamente destruida', 'success');
                    } catch (e) {
                        log(`‚ö† IndexedDB limpiada parcialmente: ${e.message}`, 'warning-log');
                    }
                } else {
                    log('IndexedDB API no disponible', 'debug');
                }

                // ============================================
                // FASE 4: DESTRUCCI√ìN DE LOCALSTORAGE
                // ============================================
                updateProgress(65, 'Fase 4/6');
                await sleep(300);
                separator();
                log('FASE 4: Evaporando LocalStorage...', 'warning-log');

                try {
                    const keysCount = localStorage.length;
                    log(`Encontradas ${keysCount} entrada(s) en LocalStorage`, 'info');

                    // Guardar todas las keys antes de borrar (por si cambia durante iteraci√≥n)
                    const allKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        allKeys.push(localStorage.key(i));
                    }

                    // Borrar una por una
                    for (const key of allKeys) {
                        if (key) {
                            localStorage.removeItem(key);
                            log(`‚úì Eliminado: ${key}`, 'success');
                        }
                    }

                    // Clear total (por si acaso)
                    localStorage.clear();

                    // Verificaci√≥n
                    if (localStorage.length === 0) {
                        log('‚úì‚úì‚úì LocalStorage COMPLETAMENTE vac√≠o', 'success');
                    } else {
                        log(`‚ö† A√∫n quedan ${localStorage.length} entrada(s)`, 'warning-log');
                    }
                } catch (e) {
                    log(`‚úó Error limpiando LocalStorage: ${e.message}`, 'error');
                }

                // ============================================
                // FASE 5: DESTRUCCI√ìN DE SESSIONSTORAGE
                // ============================================
                updateProgress(80, 'Fase 5/6');
                await sleep(300);
                separator();
                log('FASE 5: Obliterando SessionStorage...', 'warning-log');

                try {
                    const sessionCount = sessionStorage.length;
                    log(`Encontradas ${sessionCount} entrada(s) en SessionStorage`, 'info');

                    sessionStorage.clear();

                    if (sessionStorage.length === 0) {
                        log('‚úì‚úì‚úì SessionStorage COMPLETAMENTE vac√≠o', 'success');
                    } else {
                        log(`‚ö† A√∫n quedan ${sessionStorage.length} entrada(s)`, 'warning-log');
                    }
                } catch (e) {
                    log(`‚úó Error limpiando SessionStorage: ${e.message}`, 'error');
                }

                // ============================================
                // FASE 6: VERIFICACI√ìN FINAL
                // ============================================
                updateProgress(95, 'Verificaci√≥n...');
                await sleep(500);
                separator();
                log('FASE 6: Verificaci√≥n final...', 'warning-log');

                const finalRegs = await navigator.serviceWorker.getRegistrations();
                const finalCaches = await caches.keys();
                const finalLocalStorage = localStorage.length;
                const finalSessionStorage = sessionStorage.length;

                log(`Service Workers restantes: ${finalRegs.length}`, finalRegs.length === 0 ? 'success' : 'error');
                log(`Caches restantes: ${finalCaches.length}`, finalCaches.length === 0 ? 'success' : 'error');
                log(`LocalStorage items: ${finalLocalStorage}`, finalLocalStorage === 0 ? 'success' : 'error');
                log(`SessionStorage items: ${finalSessionStorage}`, finalSessionStorage === 0 ? 'success' : 'error');

                // ============================================
                // √âXITO
                // ============================================
                updateProgress(100, 'Completado');
                separator();
                log('', 'info');
                log('üéÜüéÜüéÜ DESTRUCCI√ìN TOTAL COMPLETADA üéÜüéÜüéÜ', 'success');
                log('', 'info');
                separator();

                // Preparar recarga con cache busting extremo
                const timestamp = Date.now();
                const randomParam = Math.random().toString(36).substring(7);
                const reloadUrl = `/?nocache=${timestamp}&random=${randomParam}&reset=1`;

                log(`Redirigiendo a: ${reloadUrl}`, 'info');
                log('Recargando en 3 segundos...', 'warning-log');

                await sleep(3000);

                // Usar replace para evitar historial
                window.location.replace(reloadUrl);

            } catch (error) {
                separator();
                log(`üí• ERROR CR√çTICO: ${error.message}`, 'error');
                log(error.stack, 'debug');
                console.error('Error en reset:', error);

                btn.disabled = false;
                btn.textContent = 'üí£ REINTENTAR RESET NUCLEAR üí£';
            }
        }

        function goToLogin() {
            // Redirigir con cache busting
            const timestamp = Date.now();
            window.location.replace(`/?t=${timestamp}`);
        }

        // Prevenir que el navegador cachee esta p√°gina
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                window.location.reload();
            }
        });
    </script>
</body>
</html>
